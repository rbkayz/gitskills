generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TrustTier {
  community
  bronze
  silver
  gold
}

enum ModerationStatus {
  active
  hidden
  blocked
}

model Publisher {
  id          String   @id @default(cuid())
  handle      String   @unique
  displayName String?  @map("display_name")
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  skills Skill[]
}

model Skill {
  id                 String           @id @default(cuid())
  slug               String           @unique
  name               String
  summary            String
  readmeMd           String           @map("readme_md")
  categories         String[]         @default([])
  tags               String[]         @default([])
  compatibility      String[]         @default([])
  licenseSpdx        String?          @map("license_spdx")
  homepageUrl        String?          @map("homepage_url")
  repoUrl            String?          @map("repo_url")

  downloadTotal      Int              @default(0) @map("download_total")
  trustScore         Int              @default(0) @map("trust_score")
  trustBreakdownJson Json             @default("{}") @map("trust_breakdown_json")
  trusted            Boolean          @default(false)
  trustTier          TrustTier?       @map("trust_tier")
  status             ModerationStatus @default(active)
  embedding          Float[]          @default([])

  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  publisherId        String           @map("publisher_id")
  publisher          Publisher        @relation(fields: [publisherId], references: [id], onDelete: Restrict)

  releases          Release[]
  moderationEvents  ModerationEvent[] @relation("SkillModerationEvents")
  dailyDownloads    DailySkillDownload[]

  @@index([publisherId])
  @@index([trusted, trustTier])
}

model Release {
  id               String           @id @default(cuid())
  version          String
  tarballUrl       String           @map("tarball_url")
  sha256           String
  sizeBytes        Int              @map("size_bytes")
  downloadTotal    Int              @default(0) @map("download_total")
  status           ModerationStatus @default(active)
  createdAt        DateTime         @default(now()) @map("created_at")

  skillId          String           @map("skill_id")
  skill            Skill            @relation(fields: [skillId], references: [id], onDelete: Cascade)
  moderationEvents ModerationEvent[] @relation("ReleaseModerationEvents")

  @@unique([skillId, version])
  @@index([skillId])
  @@index([status])
}

model DailySkillDownload {
  id        String   @id @default(cuid())
  day       DateTime
  count     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  skillId   String   @map("skill_id")
  skill     Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([skillId, day])
  @@index([day])
  @@index([skillId])
}

model ModerationEvent {
  id         String           @id @default(cuid())
  actor      String
  reason     String
  fromStatus ModerationStatus @map("from_status")
  toStatus   ModerationStatus @map("to_status")
  createdAt  DateTime         @default(now()) @map("created_at")

  skillId    String?          @map("skill_id")
  skill      Skill?           @relation("SkillModerationEvents", fields: [skillId], references: [id], onDelete: Cascade)

  releaseId  String?          @map("release_id")
  release    Release?         @relation("ReleaseModerationEvents", fields: [releaseId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([skillId])
  @@index([releaseId])
}
